name: Deploy Fillusion Frontend

on:
  push:
    branches:
      - master

env:
  HOME_DIR: /home/fillusion
  FRONT_ROOT: /home/fillusion/fillusion/front
  RELEASE_NAME: release_${{ github.run_number }}
  RELEASES_DIR: /home/fillusion/fillusion/front/releases
  CURRENT_LINK: /home/fillusion/fillusion/front/current
  SHARED_DIR: /home/fillusion/fillusion/front/shared
  KEEP_RELEASES: "3"
  NODE_VERSION: "20"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Ensure release directories exist
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            mkdir -p "${{ env.RELEASES_DIR }}" "${{ env.SHARED_DIR }}"

      - name: Copy dist to server
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "dist"
          target: "${{ env.RELEASES_DIR }}/${{ env.RELEASE_NAME }}/dist"
          overwrite: true
          rm: true

      - name: Activate release on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: RELEASE_NAME,RELEASES_DIR,CURRENT_LINK,KEEP_RELEASES
          script: |
            set -euo pipefail

            RELEASE_PATH="${RELEASES_DIR}/${RELEASE_NAME}"

            echo "Using prebuilt release at ${RELEASE_PATH}"

            ln -sfn "${RELEASE_PATH}" "${CURRENT_LINK}"
            echo "Current release now points to ${RELEASE_PATH}"

            echo "Cleaning up old releases, keeping ${KEEP_RELEASES}"
            cd "${RELEASES_DIR}"
            if ls -1d release_* >/dev/null 2>&1; then
              ls -1dt release_* | tail -n +$((KEEP_RELEASES + 1)) | xargs -r rm -rf
            fi

      - name: Show active release
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            if [ -L "${{ env.CURRENT_LINK }}" ]; then
              echo "Current release:"
              readlink -f "${{ env.CURRENT_LINK }}"
              echo
              ls -l "${{ env.CURRENT_LINK }}/dist" || true
            else
              echo "No current release found"
            fi
