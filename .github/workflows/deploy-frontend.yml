name: Deploy Fillusion Frontend

on:
  push:
    branches:
      - master

env:
  HOME_DIR: /home/fillusion
  FRONT_ROOT: /home/fillusion/fillusion/front
  RELEASE_NAME: release_${{ github.run_number }}
  RELEASES_DIR: /home/fillusion/fillusion/front/releases
  CURRENT_LINK: /home/fillusion/fillusion/front/current
  SHARED_DIR: /home/fillusion/fillusion/front/shared
  KEEP_RELEASES: "3"
  NODE_VERSION: "20"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build project (dist)
        run: npm run build

      - name: Cleanup unnecessary files
        run: |
          rm -rf .git .github .idea node_modules

      - name: Upload dist to server release directory
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "dist/**"
          target: "${{ env.RELEASES_DIR }}/${{ env.RELEASE_NAME }}/dist"
          
      - name: Finalize release on server (symlink + cleanup)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: HOME_DIR,FRONT_ROOT,RELEASE_NAME,RELEASES_DIR,CURRENT_LINK,SHARED_DIR,KEEP_RELEASES
          script: |
            set -euo pipefail

            RELEASE_PATH="${RELEASES_DIR}/${RELEASE_NAME}"
            PUBLIC_PATH="${RELEASE_PATH}/dist"

            echo "Using release at ${RELEASE_PATH}"
            echo "Public path (dist) ${PUBLIC_PATH}"

            mkdir -p "${RELEASES_DIR}" "${SHARED_DIR}"

            # Подхватываем .env, если нужен
            if [ -f "${SHARED_DIR}/.env" ]; then
              cp -f "${SHARED_DIR}/.env" "${PUBLIC_PATH}/.env"
            fi

            # Переключаем current на dist
            ln -sfn "${PUBLIC_PATH}" "${CURRENT_LINK}"
            echo "Current release set → ${PUBLIC_PATH}"

            # Чистка старых релизов, оставляем N штук
            cd "${RELEASES_DIR}"
            ls -1dt release_* | tail -n +$((KEEP_RELEASES + 1)) | xargs -r rm -rf || true

      - name: Verify deployed directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "=== Current symlink ==="
            ls -ld ${{ env.CURRENT_LINK }}
            echo "=== Current contents ==="
            ls -la ${{ env.CURRENT_LINK }}
            
